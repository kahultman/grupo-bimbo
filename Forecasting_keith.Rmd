---
title: "Forecasting"
author: "Keith Hultman"
date: "June 16, 2016"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(tidyr)
```

```{r try on one sample}
setwd("/Volumes/Half_Dome/datasets/grupo-bimbo/")
load("train2.Rdata")

example <- train2 %>% 
  filter(product == 5710) %>%
  filter(client == 48572)

example
# note that this is missing week 5 data
example$demand

# put demand into time series. 
example.ts <- ts(example$demand, start = 3, end = 7, frequency = 1)
example.ts
# if we don't fill in that missing data, then the time series will start over from the first observation

week5 <- data.frame(week=5, depot="1355", channel="2", route="1606", client="48572", product="5710", sales_units= 0, sales= 0, returns_units= 0, returns= 0, demand=NA)

example_complete <- example %>%
  bind_rows(week5) %>%
  arrange(week)

example_complete
example.ts <- ts(example_complete$demand, start = 3, end = 7, frequency = 1)
example.ts <- ts(c(100, 200, 300, 400, 500), start = 3, end = 7, frequency = 1)
?ts
?arima

example.arima <- arima(example.ts, order = c(3,0,0))
str(example.arima)

example.predict <- predict(example.arima, n.ahead=2)
example.predict
example.predict$pred
ts.plot(example.ts, example.predict$pred, lty=1:2)
```

Create time series for each product and client. 

```{r}
load("products.Rdata")
load("clients.Rdata")
product_client <- 

train2$product <- as.numeric(train2$product)
train2$client <- as.numeric(train2$client)
  
product_client_sample <- train2 %>%
  filter(product < 300, client < 1000)

product_client_sample <- product_client_sample %>%
  group_by(product, client, week) %>%
  summarise(p_c_w = median(demand))

product_client_sample

product_client_sample2 <- spread(product_client_sample, week, p_c_w)
product_client_sample2

z <- ts(matrix(rnorm(300), 100, 3), start = c(1961, 1), frequency = 12)
class(z)
head(z)
plot(z)


product_client_sample2.ts <- ts(product_client_sample2[,3:7], start = 3, frequency = 1)
head(product_client_sample2.ts)
str(product_client_sample2.ts)

product_client_matrix <- as.matrix(product_client_sample2[,3:7])

product_client_matrix

product_client_sample2$median <- rowMedians(product_client_matrix, na.rm=TRUE)

product_client_sample2$median <- na.exclude(product_client_sample2$w3 + product_client_sample2$w4 +
                                    product_client_sample2$w5 + product_client_sample2$w6 +
                                    product_client_sample2$w7) / 5

colnames(product_client_sample2) <- c("product", "client", "w3", "w4", "w5", "w6", "w7")


product_client_sample2 <- product_client_sample2 %>%
  group_by(product, client) %>%
  do(tseries = ts()
    
  )


```

