---
title: "Data Exploration of Grupo Bimbo Data Set"
author: "Keith Hultman"
date: "June 13, 2016"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(tidyr)
library(data.table)
library(feather)
library(ggplot2)
```
# Load Data

```{r}
setwd("/Volumes/Half_Dome/datasets/grupo-bimbo/")
load("train1.Rdata")
load("train2.Rdata")
load("validate.Rdata")
load("test.Rdata")
load("clients.Rdata")
load("products.Rdata")
load("town_state.Rdata")
```



## Is current human model under estimating demand?

```{r}
wks <- unique(train2$week)
wks <- data.table(wks)
train2 <- data.table(train2)


# From Carolyn, merge all possible weeks to data frame. 
dates <- train2 %>%
  group_by(week) %>%
  summarise(dummy=1)

combinations <- train2 %>%
  group_by(product, client, depot) %>%
  summarise(earliest_week=min(week),
            dummy=1)

#combine combinations and dates using dummy variable (all possible combinatons including missing rows)
combinations <- combinations %>%
  left_join(dates, by="dummy") %>%
  filter(week>=earliest_week) #CAN CHANGE DURING TESTING: only keep weeks starting with earliest sales (assuming no sale before first sale)

combinations <- combinations %>%
  left_join(train2, by=c("product", "week", "client", "depot")) 

combinations2 <- combinations %>% 
  select(-dummy) %>% 
  group_by(product, client, depot) %>%
  arrange(week) %>% 
  mutate(sales_delta = sales_units - lag(sales_units), sales_lead_delta = sales_units - lead(sales_units))

combinations2 <- mutate(combinations2, hasreturn = (returns_units > 0))

combinations2[is.na(combinations2)] <- 0
summary(combinations2$sales_lead_delta)

sum(combinations2$returns_units > 0) / length(combinations2$returns_units)
  
prev_returned <- combinations2 %>% filter(prev_return > 0)
prev_notreturn <- combinations2 %>% filter(prev_return = 0)

colnames(combinations)  

ggplot(combinations2, aes(x=hasreturn, y= sales_lead_delta)) + geom_boxplot()



